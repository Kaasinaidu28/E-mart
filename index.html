<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>E-Mart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/jpg" href="../images/Emart fav.webp">
  
  <script>
     function hideProducts() {
    document.getElementById("productSection").style.display = "none";
  }//hide products


    function handleLogin(event) {
  event.preventDefault();

  const mail_id = document.getElementById("mail-id").value.trim();
  const lpassword = document.getElementById("login-password").value.trim();

  if (!mail_id || !lpassword) {
    alert("All fields are required");
    return;
  }

  fetch("http://localhost:5000/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mail_id, lpassword })
  })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      if (data.message === "Sign in successfully") {
        document.getElementById("mail-id").value = '';
          document.getElementById("login-password").value = '';

        bootstrap.Modal.getInstance(document.getElementById("loginModal")).hide();
        document.getElementById("productSection").style.display = "flex";

          const firstLetter = mail_id.charAt(0).toUpperCase();

          document.getElementById("usericon").innerHTML = `
          <span class="rounded-circle bg-warning d-inline-flex justify-content-center align-content-center text-dark" style="width: 30px; height: 30px; font-weight="bold";" data-bs-toggle="modal" data-bs-target="#userlogout" title = "My Account"> ${firstLetter} </span>

          `;
          document.getElementById("userMailid").textContent = mail_id;

      }
    })
    .catch(err => {
      alert("Login failed: " + err.message);
    });
}// Login Handle


 function signout(){

    document.getElementById("usericon").innerHTML =`<span class="bi bi-person"> Sign In</span>`;

    document.getElementById("usericon").setAttribute("onclick", "hideproducte()");
      document.getElementById("usericon").setAttribute("data-bs-toggle", "modal");
        document.getElementById("usericon").setAttribute("data-bs-target", "#loginModal");

         bootstrap.Modal.getInstance(document.getElementById("userlogout")).hide();
    alert("You have signed out.");

 } //Sign Out


  function verifyPassword(){
     const password = document.getElementById("password").value.trim();
  const repassword = document.getElementById("repassword").value.trim();
    const error = document.getElementById("error");
       if(password !== repassword){
      error.innerHTML = "Password Not Matched".fontcolor('red');
    }
    else{
      error.innerHTML = "Password Matched".fontcolor('green')
    }

    } // Password Verification

function saveDetails(event){

    event.preventDefault();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const number = document.getElementById("number").value.trim();
  const password = document.getElementById("password").value.trim();
  const repassword = document.getElementById("repassword").value.trim();
 
  // Email format check
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailPattern.test(email)) {
    alert("Please enter a valid email address.");
    return;
  }

  // Mobile number check (10 digits)
  if (!/^\d{10}$/.test(number)) {
    alert("Please enter a valid 10-digit mobile number.");
    return;
  }

  
  fetch('http://localhost:5000/register', {
    method:"POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({name, email, number, password, repassword})
  })
  .then(res => res.json())
  .then(data =>{
    alert(data.message)

    document.getElementById("name").value = '';
    document.getElementById("email").value = '';
     document.getElementById("number").value = '';
      document.getElementById("password").value ='';
      document.getElementById("repassword").value ='';

   const newUserModal = bootstrap.Modal.getInstance(document.getElementById("newuser"));
    newUserModal.hide();
   const loginModal =  bootstrap.Modal.getInstance(document.getElementById("loginModal"));
   loginModal.show();

document.getElementById("productSection").style.display = "flex";

  })
   .catch(err => {
      alert("Error: " + err.message);
    });

} // New Register


function searchProducts() {
  const searchQuery = document.getElementById("searchInput").value.toLowerCase().trim();
  if (!searchQuery) {
    LoadProducts("https://fakestoreapi.com/products");
    return;
  }
   document.getElementById("searchInput").value = "";
  fetch("https://fakestoreapi.com/products")
    .then(res => res.json())
    .then(products => {
      const filtered = products.filter(product =>
        product.title.toLowerCase().includes(searchQuery)
      );

      document.querySelector("main").innerHTML = "";

      if (filtered.length === 0) {
        document.querySelector("main").innerHTML = `
          <div class="alert alert-warning w-100 text-center">
            <strong>No products found for "${searchQuery}".</strong>
          </div>
        `;
        return;
      }

      filtered.forEach(product => {
        let div = document.createElement("div");
        div.className = "card m-2 p-2";
        div.style.width = "190px";
        div.innerHTML = `
          <img src="${product.image}" height="100px" class="card-img-top" onclick="showProductDetails(${product.id})">
          <div class="card-header" style="height:140px">
            <div>${product.title}</div>
          </div>
          <div class="card-body">
            <dl>
              <dt>Price</dt>
              <dd>$${product.price}</dd>
              <dt>Rating</dt>
              <dd><span class="text-success"><span class="bi bi-star-fill"></span></span> ${product.rating.rate} [${product.rating.count}]</dd>
            </dl>
          </div>
          <div class="card-footer">
            <button class="btn btn-danger" onclick="addCart(${product.id}, '${product.title}', '${product.image}', ${product.price})">
              <span class="bi bi-cart3"></span> Add to Cart
            </button>
          </div>
        `;
        document.querySelector("main").appendChild(div);
      });
    });
} // Product Search


    let cartItem = [];
    let allorders = [];

    function BodyLoad() {
      LoadCategories();
      LoadProducts("https://fakestoreapi.com/products");
      cartCount();
    }

    function LoadCategories() {
      fetch("https://fakestoreapi.com/products/categories")
        .then(res => res.json())
        .then(categories => {
          categories.unshift("all");
          categories.forEach(category => {
            let option = document.createElement("option");
            option.text = category.toUpperCase();
            option.value = category;
            document.getElementById("lstCategories").appendChild(option);
          });
        });
    } // Load Categories

    function LoadProducts(url) {
      document.querySelector("main").innerHTML = "";
      fetch(url)
        .then(res => res.json())
        .then(products => {
          products.forEach(product => {
            let div = document.createElement("div");
            div.className = "card m-2 p-2";
            div.style.width = "190px";
            div.innerHTML = `
              <img src="${product.image}" height="100px" class="card-img-top" onclick="showProductDetails(${product.id})">
              <div class="card-header" style="height:140px">
                <div>${product.title}</div>
              </div>
              <div class="card-body">
                <dl>
                  <dt>Price</dt>
                  <dd>$${product.price}</dd>
                  <dt>Rating</dt>
                  <dd><span class="text-success"><span class="bi bi-star-fill"></span></span> ${product.rating.rate} [${product.rating.count}]</dd>
                </dl>
              </div>
              <div class="card-footer">
                <button class="btn btn-danger" onclick="addCart(${product.id}, '${product.title}', '${product.image}', ${product.price})">
                  <span class="bi bi-cart3"></span> Add to Cart 
                </button>
              </div>
            `;
            document.querySelector("main").appendChild(div);
          });
        });
    }

    function loadChangeCategory() {
      let category = document.getElementById("lstCategories").value;
      let url = category === "all"  ? "https://fakestoreapi.com/products" : `https://fakestoreapi.com/products/category/${category}`;
      
      LoadProducts(url);
    }

    function cartCount() {
      document.getElementById("lblCount").innerText = cartItem.length;
    }

    function addCart(id, title, image, price) {
      cartItem.push({ id, title, image, price });
      alert(`${title} Added to Cart Successfully.`);
      cartCount();
      showCart();
    }

    function removeFromCart(index) {
      cartItem.splice(index, 1);
      cartCount();
      showCart();
    }

    function showCart() {
      let tbody = document.querySelector("#cart tbody");
      tbody.innerHTML = "";
      cartItem.forEach((product, index) => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${product.title}</td>
          <td><img src="${product.image}" width="50" height="50"></td>
          <td>$${product.price}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">
              <span class="bi bi-trash"></span> Remove
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("orderBtn").style.display = cartItem.length > 0 ? "block" : "none";
    } // Cart Show


    function placeOrder() {
      if (cartItem.length === 0) {
        alert("Your cart is empty!");
        return;
      }
      let total = cartItem.reduce((sum, p) => sum + p.price, 0);
      alert(`Order placed successfully!\nTotal Amount: $${total.toFixed(2)}`);
      allorders.push(...cartItem);

      cartItem = [];
      cartCount();
      showCart();
    }// PlaceOrder

    function showMyOrders(){
      let html = '';
      if (allorders.length === 0){
        html = ` <div class="alert alert-warning text-center"> No products added yet</div>`;
      }
      else {
        html = `<h4 class="text-center mb-3">Your Ordered Products</h4><div class="row justify-content-center">`;
      

      allorders.forEach(product =>{
            html += `
        <div class="card m-2 p-2" style="width: 180px;">
          <img src="${product.image}" height="100px" class="card-img-top">
          <div class="card-body text-center">
            <div class="fw-bold">${product.title}</div>
            <div class="text-success">$${product.price}</div>
           <button class="btn btn-danger text-center" onclick="cancelOrder(this)">Cancel Order</button>
          </div>
        </div>`;
 });
    html += `</div>`;

    }
    document.getElementById("ordersBody").innerHTML = html;

   const ordersModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("ordersModal"));
   ordersModal.show();
   const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("ordersBody"));
   modal.hide();
    
    }// show ordered Products

  function cancelOrder(button) {
  const card = button.closest(".card");
  const title = card.querySelector(".fw-bold").innerText;

  // Remove from allorders array
  allorders = allorders.filter(product => product.title !== title);

  alert("Order Cancelled");

  // Re-render orders
  showMyOrders();
  
}
  

    function showProductDetails(id) {
      fetch(`https://fakestoreapi.com/products/${id}`)
        .then(res => res.json())
        .then(product => {
          document.getElementById("productImage").src = product.image;
          document.getElementById("productTitle").innerText = product.title;
          document.getElementById("productDescription").innerText = product.description;
          document.getElementById("productPrice").innerText = `$${product.price}`;
          document.getElementById("productRating").innerHTML =
            `<span class="bi bi-star-fill text-warning"></span> ${product.rating.rate} (${product.rating.count} Reviews)`;
          document.getElementById("addToCartBtn").setAttribute("onclick", `addCart(${product.id}, '${product.title}', '${product.image}', ${product.price})`);
          new bootstrap.Modal(document.getElementById("productModal")).show();
        });
    }

    function loadpage(){
      document.querySelector("section").style.display = "flex";
    }
  </script>

<!-- Bootstrap 5 Bundle JS (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
  header{
    display: flex;
    position: sticky;
    top: 0;
    z-index: 1000;
    justify-content: space-around;
    padding: 10px;
    color: white;
    background-color: black;
    width: 100%;
  }
  body{
    margin: 0;
    padding: 0;
  }
   
  </style>
</head>

<body onload="BodyLoad()">
  <header> 
    <div class="h3" style="cursor: pointer;" onclick="loadpage()">E-MART</div>
      <div class=" input-group w-50 ms-5" >
    <input type="search" id="searchInput" class="form-control" placeholder="Search products..."  />
    <button class="btn btn-warning" onclick="searchProducts()"><span class="bi bi-search"></span></button>
  </div>
    <div class="cart1">
      <span  id="usericon" onclick="hideProducts()" class="me-5" data-bs-toggle="modal" data-bs-target="#loginModal"  style="cursor: pointer;"><span  class="bi bi-person " ></span> Sign In</span>
      
      <span class="bi bi-cart-fill me-5" onclick="showMyOrders()"  style="cursor: pointer;"> My Orders</span>

      <button onclick="showCart()" class="btn btn-light position-relative" data-bs-toggle="modal" data-bs-target="#cart">
        Your cart <span class="bi bi-cart me-2"></span>
        <span class="badge rounded-circle bg-danger position-absolute top-0 end-0" id="lblCount">0</span>
      </button>
      
    </div>
  </header>

  <section class="row" id="productSection">
    <nav class="col-2">
      <label class="form-label fw-bold">Select Category</label>
      <select class="form-select w-100" id="lstCategories" onchange="loadChangeCategory()"></select>
    </nav>
    <main class="col-10 d-flex flex-wrap overflow-auto" style="height:600px"></main>
  </section>

  <!-- Cart Modal -->
  <div class="modal fade" id="cart">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-primary">Cart Items</h3>
          <button class="btn btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Image</th>
                <th>Price</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <button id="orderBtn"  class="btn btn-success w-100 mt-2" onclick="placeOrder()">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Details Modal -->
  <div class="modal fade" id="productModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="productTitle"></h3>
          <button class="btn btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="productImage" width="200" class="mb-2" />
          <p id="productDescription"></p>
          <h4 id="productPrice" class="text-success"></h4>
          <p id="productRating"></p>
        </div>
        <div class="modal-footer">
          <button id="addToCartBtn" class="btn btn-danger">Add to Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
<div class="modal fade" id="loginModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">User Login</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
       <form  onsubmit="handleLogin(event);">
          <div class="mb-3">
            <label class="form-label">Mail ID</label>
            <input type="text" id="mail-id" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="login-password" class="form-control" required />
          </div>
          <div class="modal-footer">
            <a  class="me-5"href="#" data-bs-toggle="modal" data-bs-target="#newuser">New Register? </a>
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- New Register -->

<div class="modal fade" id="newuser">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Register</h5>
                <button class="btn btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <div class="mb-3">
                <form onsubmit="saveDetails(event);">
                    <div class="mb-3">
                 <label class=" form-label">Your Name</label>
                <input type="name" id="name" class="form-control" placeholder="Enter Your Name"  required>
                </div>
                <div class="mb-3">
                    <label class=" form-label">Email id</label>
                <input type="text" id="email" class="form-control" placeholder="Enter Email" required>
                 </div>
                   <div class="mb-3">
                    <label class=" form-label">Mobile Number</label>
                <input type="text" id="number" class="form-control" placeholder="Enter Mobile Number"  required>
                 </div>
                   <div class="mb-3">
                    <label class=" form-label">Create Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter New Password"  required>
                </div>
                <div class="mb-3">
                    <label class=" form-label">Conform Password</label>
                <input type="password" id="repassword" class="form-control" placeholder="Re Enter Your Password"  onkeyup="verifyPassword()" required>
                  <h6 id="error" class="mt-2"></h6>
                     </div>
                <div class="modal-footer">
                    <button class="btn btn-success">Save Your Details</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
                </form>
            </div>
            </div>
        </div>
    </div>
</div>

   <!-- Sign Out modal -->

   <div class="modal fade" id="userlogout">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">My Account</h3>
          <button class="btn btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p>Welcome <strong id="userMailid"></strong></p>
          <button class="btn btn-danger" onclick="signout()">Log Out</button>
        </div>
      </div>
    </div>
   </div>
   
 <!-- Order modal -->
   <div class="modal fade" id="ordersModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">My Orders</h3>
        <button class="btn btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="ordersBody">
        <!-- Orders will load here -->
      </div>
    </div>
  </div>
</div>
    

</body>
</html>
